services:
  # ============================================
  # Base de Datos
  # ============================================
  inclusive-mongodb:
    image: mongo:8.0.3
    container_name: inclusive-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_DATABASE=${SPRING_DATA_MONGODB_DATABASE}
      - MONGO_INITDB_ROOT_HOST=${SPRING_DATA_MONGODB_HOST}
      - MONGO_INITDB_ROOT_USERNAME=${SPRING_DATA_MONGODB_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${SPRING_DATA_MONGODB_PASSWORD}
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - microservices-net
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # Eureka Server (Service Discovery)
  # ============================================
  eureka-server:
    build:
      context: .
      dockerfile: eureka-server/Dockerfile
    container_name: eureka-server
    restart: unless-stopped
    ports:
      - "8761:8761"
    env_file:
      - .env
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_INSTANCE_HOSTNAME=eureka-server
    networks:
      - microservices-net
    depends_on:
      - inclusive-mongodb
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8761/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  # ============================================
  # Authentication Service
  # ============================================
  authentication-service:
    build:
      context: .
      dockerfile: authentication-service/Dockerfile
    container_name: authentication-service
    ports:
      - "9090:9090"
    env_file:
      - .env
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_DATA_MONGODB_URI=${SPRING_DATA_MONGODB_URI}
    depends_on:
      eureka-server:
        condition: service_healthy
      inclusive-mongodb:
        condition: service_healthy
    networks:
      - microservices-net

#  # ============================================
#  # Account API
#  # ============================================
#  account-api:
#    build:
#      context: .
#      dockerfile: account-API/Dockerfile
#    container_name: account-api
#    restart: unless-stopped
#    ports:
#      - "8082:8082"
#    environment:
#      - SPRING_PROFILES_ACTIVE=docker
#      - SPRING_DATA_MONGODB_URI=mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD:-admin123}@mongodb:27017/accounts?authSource=admin
#      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
#    depends_on:
#      eureka-server:
#        condition: service_healthy
#      mongodb:
#        condition: service_healthy
#    networks:
#      - microservices-net

  # ============================================
  # Route API
  # ============================================
  route-api:
    build:
      context: .
      dockerfile: route-API/Dockerfile
    container_name: route-api
    ports:
      - "8060:8060"
    env_file:
      - .env
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_DATA_MONGODB_URI=${SPRING_DATA_MONGODB_URI}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
    depends_on:
      eureka-server:
        condition: service_healthy
      inclusive-mongodb:
        condition: service_healthy
    networks:
      - microservices-net

  # ============================================
  # Location API
  # ============================================
  location-api:
    build:
      context: .
      dockerfile: location-API/Dockerfile
    container_name: location-api
    ports:
      - "8070:8070"
    env_file:
      - .env
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_DATA_MONGODB_URI=${SPRING_DATA_MONGODB_URI}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
#      - AWS_REGION=${AWS_REGION:-us-east-1}
#      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
#      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
#      - SPRING_MAIL_HOST=${MAIL_HOST:-smtp.gmail.com}
#      - SPRING_MAIL_PORT=${MAIL_PORT:-587}
#      - SPRING_MAIL_USERNAME=${MAIL_USERNAME}
#      - SPRING_MAIL_PASSWORD=${MAIL_PASSWORD}
    depends_on:
      eureka-server:
        condition: service_healthy
      inclusive-mongodb:
        condition: service_healthy
    networks:
      - microservices-net

  # ============================================
  # Gateway Service (Ãºltimo en iniciar)
  # ============================================
  gateway-service:
    build:
      context: .
      dockerfile: gateway-service/Dockerfile
    container_name: gateway-service
    ports:
      - "8080:8080"
    env_file:
      - .env
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
    depends_on:
      eureka-server:
        condition: service_healthy
      authentication-service:
        condition: service_started
#      account-api:
#        condition: service_started
      route-api:
        condition: service_started
      location-api:
        condition: service_started
    networks:
      - microservices-net

# ============================================
# Networks
# ============================================
networks:
  microservices-net:
    driver: bridge

# ============================================
# Volumes
# ============================================
volumes:
  mongodb_data:
  mongodb_config:
